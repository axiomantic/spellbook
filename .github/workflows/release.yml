# Auto-Release Workflow
#
# Automatically creates tags and GitHub releases when .version file changes on main.
#
# When .version is bumped (e.g., 0.2.1 -> 0.3.0):
# 1. Creates semver tag (v0.3.0)
# 2. Creates GitHub release with notes extracted from CHANGELOG.md
# 3. Force-updates floating major version tag (v0) to point to new release
#
# Usage:
# 1. Update CHANGELOG.md with new version section (## [X.Y.Z] - YYYY-MM-DD)
# 2. Update .version file with new version number
# 3. Commit and push/merge to main
# 4. Workflow automatically creates release

name: Auto Release

on:
  push:
    branches:
      - main
    paths:
      - .version

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version from .version file
        id: version
        run: |
          VERSION=$(cat .version | tr -d '[:space:]')
          if [[ -z "$VERSION" ]]; then
            echo "::error::.version file is empty"
            exit 1
          fi

          # Validate version format (semver: X.Y.Z)
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION (expected X.Y.Z)"
            exit 1
          fi

          # Extract major version for floating tag
          MAJOR_VERSION=$(echo "$VERSION" | cut -d. -f1)

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"
          echo "major_tag=v$MAJOR_VERSION" >> "$GITHUB_OUTPUT"

          echo "Detected version: $VERSION"
          echo "Semver tag: v$VERSION"
          echo "Major tag: v$MAJOR_VERSION"

      - name: Check if tag already exists
        id: check_tag
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::notice::Tag $TAG already exists. Skipping release."
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "Tag $TAG does not exist. Will create release."
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract release notes from CHANGELOG.md
        if: steps.check_tag.outputs.exists == 'false'
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          MAJOR_TAG="${{ steps.version.outputs.major_tag }}"
          REPO="${{ github.repository }}"

          # Extract the section for this version from CHANGELOG.md
          if [[ -f "CHANGELOG.md" ]]; then
            awk -v ver="$VERSION" '
              /^## \[/ {
                if (found) exit
                if (index($0, "[" ver "]")) found=1
              }
              found { print }
            ' CHANGELOG.md > /tmp/release_notes.md

            if [[ -s /tmp/release_notes.md ]]; then
              echo "Found release notes for version $VERSION in CHANGELOG.md"
            else
              echo "No release notes found for version $VERSION in CHANGELOG.md"
              echo "## $VERSION" > /tmp/release_notes.md
              echo "" >> /tmp/release_notes.md
              echo "No release notes provided for this version." >> /tmp/release_notes.md
            fi
          else
            echo "CHANGELOG.md not found, using commit log"
            PREV_TAG=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-version:refname | head -1)
            echo "## What's Changed" > /tmp/release_notes.md
            echo "" >> /tmp/release_notes.md
            if [[ -n "$PREV_TAG" ]]; then
              git log --oneline "$PREV_TAG"..HEAD --no-merges | head -20 >> /tmp/release_notes.md
            else
              git log --oneline -20 --no-merges >> /tmp/release_notes.md
            fi
          fi

          # Append footer using heredoc (written to separate file, then appended)
          PREV_TAG=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-version:refname | head -1)
          PREV_TAG="${PREV_TAG:-main}"
          {
            echo ""
            echo "---"
            echo ""
            echo "**Full Changelog**: https://github.com/${REPO}/compare/${PREV_TAG}...${TAG}"
            echo ""
            echo "---"
            echo ""
            echo "_This release was automatically created when .version was updated to ${VERSION}._"
            echo ""
            echo "The floating tag \`${MAJOR_TAG}\` now points to this release."
          } >> /tmp/release_notes.md

          echo "Release notes generated"

      - name: Create semver tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$TAG" -m "Release $VERSION"
          git push origin "$TAG"

          echo "Created and pushed tag: $TAG"

      - name: Create GitHub release
        if: steps.check_tag.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          gh release create "$TAG" \
            --title "Release $VERSION" \
            --notes-file /tmp/release_notes.md

          echo "Created GitHub release: $TAG"

      - name: Update floating major version tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          MAJOR_TAG="${{ steps.version.outputs.major_tag }}"
          TAG="${{ steps.version.outputs.tag }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Delete local tag if exists
          git tag -d "$MAJOR_TAG" 2>/dev/null || true

          # Create new tag pointing to current commit
          git tag -a "$MAJOR_TAG" -m "Latest $MAJOR_TAG release - points to $TAG"

          # Force push to update remote
          git push origin "$MAJOR_TAG" --force

          echo "Updated floating tag $MAJOR_TAG to point to $TAG"

      - name: Summary
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          MAJOR_TAG="${{ steps.version.outputs.major_tag }}"

          echo "## Release Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Semver Tag**: \`$TAG\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Floating Tag**: \`$MAJOR_TAG\` (updated)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/$TAG)" >> "$GITHUB_STEP_SUMMARY"

      - name: Skip summary
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          echo "## Release Skipped" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Tag ${{ steps.version.outputs.tag }} already exists." >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "To create a new release, bump the version in .version file." >> "$GITHUB_STEP_SUMMARY"
